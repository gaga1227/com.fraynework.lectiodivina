/**
 * Flickable: a Zepto plugin for making elements flickable on a touch device
 * 2012, Tom Longo
 *
 * Licensed under the Whatever License. Use it for whatever you want!
 * 
 * @author thetomlongo@gmail.com
 * @version 1.0.4
 * 
 * @requires 
 * Zepto JavaScript Library
 *
 * @updates
 * JX 20130724: 
 * - Added custom setting of 'moveThreshold' to determine whether touchmove distances are big enough to trigger move function
 	 a higher threshold will improve UX on bi-axis flickring/scrolling
 */
(function(g){var f,e={start:{x:0,y:0,time:0},delta:{prevPos:{x:0,y:0},dist:{x:0,y:0},dir:{x:0,y:0}},end:{duration:0,speed:{x:0,y:0},flick:{x:0,y:0}}},m=false,s=0,c=0.7,q=5,k=false;var p={init:function(t){var u=g.extend({enableDebugger:false,segments:5,snapSpeed:0.3,flickSnapSpeed:0.3,moveThreshold:0,flickThreshold:false,segmentPx:"auto",flickDirection:"auto",preventDefault:true,preventDefaultAxis:"both",onCreate:false,onFlick:false,onFlickLeft:false,onFlickRight:false,onFlickUp:false,onFlickDown:false,onScroll:false,onScrollNext:false,onScrollPrev:false,onMove:false,onStart:false,onEnd:false},t);return this.each(function(){var w=g(this),y=w.data("isAlive");if(!y){var v=u.segments,x=b(w,u.flickDirection);w.data("isAlive",true).data("pos",0).data("snapSpeed",parseFloat(u.snapSpeed)).data("flickSnapSpeed",parseFloat(u.flickSnapSpeed)).data("moveThreshold",Math.abs(parseFloat(u.moveThreshold))).data("segment",0).data("segments",v).data("flickDirection",x).data("segmentPx",j(w,u.segmentPx)).data("preventDefaultAxis",u.preventDefaultAxis);g(w).bind({onStart:function(){g(this).flickable("start",u.onStart)},onMove:function(){g(this).flickable("move",u.onMove)},onEnd:function(){g(this).flickable("finished",u.onEnd)},onScroll:function(){g(this).flickable("scrollToSegment",u.onScroll)},onScrollPrev:function(){g(this).flickable("prevSegment",u.onScrollPrev)},onScrollNext:function(){g(this).flickable("nextSegment",u.onScrollNext)},onFlick:function(){g(this).flickable("flick",u.onFlick)},onFlickLeft:function(){g(this).flickable("flickLeft",u.onFlickLeft)},onFlickRight:function(){g(this).flickable("flickRight",u.onFlickRight)},onFlickUp:function(){g(this).flickable("flickUp",u.onFlickUp)},onFlickDown:function(){g(this).flickable("flickDown",u.onFlickDown)},touchstart:function(z){n(z);g(this).trigger("onStart")},touchmove:function(z){l(z);if(u.preventDefault){o.call(this,z)}g(this).trigger("onMove")},touchend:function(z){h(z);g(this).trigger("onEnd")}});if(!i("transform")){m=true}if(parseInt(u.flickThreshold)){c=parseInt(u.flickThreshold)}if(k||u.enableDebugger){a()}w.flickable("create",u.onCreate)}})},create:function(u){var t=g(this);f=e;s++;d("It's alive!");if(!t.attr("id")){t.attr("id","flickable"+s)}t.flickable("scrollToSegment");if(typeof u=="function"){u.call(this,s)}},start:function(x){d("Touch start");var u=g(this),v=parseInt(u.data("segment")),w=parseInt(u.data("segmentPx")),t=-(w*v);u.data("anchor",t);if(typeof x=="function"){x.call(this,f)}},segment:function(t){var v=g(this),u=parseInt(v.data("segments")),w=parseInt(v.data("segment"));if(typeof t!="undefined"){if(t>=u){t=(u-1)}else{if(t<0){t=0}}if(t!==w){v.data("segment",t).trigger("onScroll")}else{v.flickable("scrollToSegment")}}return parseInt(v.data("segment"))},move:function(A){var w=g(this),z,v,y=w.data("flickDirection"),t=parseInt(w.data("anchor")),x=f.delta.dist[y],u=w.data("moveThreshold"),z=Math.abs(x)>u?t+x+(x<0?u:u*-1):t+0;if(m){if(y=="y"){w.css("top",z)}else{w.css("left",z)}}else{(y=="y")?v="(0,"+z+"px,0)":v="("+z+"px,0,0)";if(typeof document.getElementById(w.attr("id")).style.webkitTransform!="undefined"){document.getElementById(w.attr("id")).style.webkitTransform="translate3d"+v}else{if(typeof document.getElementById(w.attr("id")).style.mozTransform!="undefined"){document.getElementById(w.attr("id")).style.mozTransform="translate3d"+v}else{document.getElementById(w.attr("id")).style.transform="translate3d"+v}}}g(this).data("pos",z);if(typeof A=="function"){A.call(this,f)}},scrollNext:function(){g(this).trigger("onScrollNext")},scrollPrev:function(){g(this).trigger("onScrollPrev")},nextSegment:function(v){d("Next segment");var t=g(this),u=parseInt(t.data("segment"))+1;t.flickable("segment",u);if(typeof v=="function"){v.call(this,f,u)}},prevSegment:function(v){d("Previous segment");var t=g(this),u=parseInt(t.data("segment"))-1;t.flickable("segment",u);if(typeof v=="function"){v.call(this,f,u)}},flick:function(u){d("You flicked");var t=g(this);switch(f.end.flick.x){case -1:t.trigger("onFlickLeft");break;case 1:t.trigger("onFlickRight");break}switch(f.end.flick.y){case -1:t.trigger("onFlickUp");break;case 1:t.trigger("onFlickDown");break}if(typeof u=="function"){u.call(this,f)}},flickLeft:function(v){d("Flicked left");var t=g(this),u=parseInt(t.data("segment"));t.trigger("onScrollNext");if(typeof v=="function"){v.call(this,f,u)}},flickRight:function(v){d("Flicked right");var t=g(this),u=parseInt(t.data("segment"));t.trigger("onScrollPrev");if(typeof v=="function"){v.call(this,f,u)}},flickUp:function(v){d("Flicked up");var t=g(this),u=parseInt(t.data("segment"));t.trigger("onScrollNext");if(typeof v=="function"){v.call(this,f,u)}},flickDown:function(v){d("Flicked down");var t=g(this),u=parseInt(t.data("segment"));t.trigger("onScrollPrev");if(typeof v=="function"){v.call(this,f,u)}},scrollToSegment:function(D){var v=g(this),t,A=v.data("flickDirection"),u=parseFloat(v.data("snapSpeed")),w=parseFloat(v.data("flickSnapSpeed")),x=parseInt(v.data("segments")),y=parseInt(v.data("segment")),B=parseInt(v.data("segmentPx")),C=-(B*y),z="ease-out";d("Sliding to segment "+y);if(f.end.flick.x||f.end.flick.y){u=w;z="cubic-bezier(0, .70, .35, 1)"}v.data("anchor",C).data("pos",C).data("segment",y);if(m){if(A=="y"){v.anim({top:C},u,z)}else{v.anim({left:C},u,z)}}else{(A=="y")?t="0px, "+C+"px, 0px":t=C+"px, 0px, 0px";v.anim({translate3d:t},u,z)}if(typeof D=="function"){D.call(this,f,y)}},finished:function(B){var t=g(this),x=t.data("flickDirection"),v=parseInt(t.data("segments")),w=parseInt(t.data("segment")),y=parseInt(t.data("segmentPx")),u=parseInt(t.data("anchor")),A=parseInt(t.data("pos"));var z;(A<0)?z=Math.abs(Math.round(A/y)):z=0;d("Nearest segment is "+z);if(typeof B=="function"){B.call(this,f,w)}if(w==z){if(f.end.flick[x]){return t.trigger("onFlick")}}if(z==(w+1)){t.trigger("onScrollNext")}else{if(z==(w-1)){t.trigger("onScrollPrev")}else{t.flickable("segment",z)}}}};g.fn.flickable=function(t){if(p[t]){return p[t].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof t==="object"||!t){return p.init.apply(this,arguments)}else{g.error("Method "+t+" does not exist")}}};function n(v){var u,t;(typeof v.touches[0].pageX!="undefined")?u=v.touches[0].pageX:u=v.pageX;(typeof v.touches[0].pageY!="undefined")?t=v.touches[0].pageY:t=v.pageY;f=e;f.start={x:u,y:t,time:v.timeStamp};f.delta.prevPos={x:u,y:t};l(v);if(k){r()}}function l(y){var w,v;(typeof y.touches[0].pageX!="undefined")?w=y.touches[0].pageX:w=y.pageX;(typeof y.touches[0].pageY!="undefined")?v=y.touches[0].pageY:v=y.pageY;var u,t,z=w,x=v,B=w-f.start.x,A=v-f.start.y;if(w>f.delta.prevPos.x){u=1}else{if(w<f.delta.prevPos.x){u=-1}else{u=0}}if(v>f.delta.prevPos.y){t=1}else{if(v<f.delta.prevPos.y){t=-1}else{t=0}}f.delta.prevPos={x:z,y:x};f.delta.dist={x:B,y:A};f.delta.dir={x:u,y:t};if(k){r()}}function o(y){var v=g(this),u=v.data("preventDefaultAxis"),w=u==="both"||u==="x",t=u==="both"||u==="y",x=w&&Math.abs(f.delta.dist.y)>=q,z=t&&Math.abs(f.delta.dist.x)>=q;if(x||z){y.preventDefault()}}function h(A){var z=(A.timeStamp-f.start.time),y=Math.abs(Math.round(f.delta.dist.x/z*100)/100),x=Math.abs(Math.round(f.delta.dist.y/z*100)/100),u=f.delta.dir.x,t=f.delta.dir.y,w=0,v=0;if((y>c)){(Math.abs(f.delta.dist.x)>=q)?w=u:w=0}else{if((x>c)){(Math.abs(f.delta.dist.y)>=q)?v=t:v=0}}f.end.duration=z;f.end.speed={x:y,y:x};f.end.flick={x:w,y:v};if(k){d("Touch end");r()}}function b(t,u){if((u!=="x")&&(u!=="y")){(t.height()>t.width())?u="y":u="x"}return u}function j(u,w){if(!parseInt(w)){var w,t=u.data("segments"),v=b(u,u.data("flickDirection"));(v=="y")?w=u.height()/t:w=u.width()/t}return w}function i(w){var v=document.createElement("div"),u="Khtml Ms O Moz Webkit".split(" "),t=u.length;return function(x){if(x in v.style){return true}x=x.replace(/^[a-z]/,function(y){return y.toUpperCase()});while(t--){if(u[t]+x in v.style){return true}}return false}}function a(){if(!g("#flickableDebugger").length){k=true;f=e;f.eventLog=[];var t='<div id="flickableDebugger" style="position: fixed; bottom: 0; margin: 0 auto; padding: 10px; width: 100%; background: #000; color: #fff; font-family: courier, sans-serif;">Debugger</div>';g("body").append(t)}}function d(t){if(k){console.log(t);f.eventLog.splice(0,0,t);r()}}function r(){var u="";for(var t=0;t<3;t++){u+=f.eventLog[t]+" | "}var v="<pre> 		last 3 events: "+u+"<br /> 		start: {x:"+f.start.x+", y:"+f.start.y+",time: "+f.start.time+"}<br /> 			delta: {<br /> 			prevPos: {"+f.delta.prevPos.x+", "+f.delta.prevPos.y+"}<br /> 			dist: {"+f.delta.dist.x+", "+f.delta.dist.y+"}<br /> 			dir: {"+f.delta.dir.x+", "+f.delta.dir.y+"}<br /> 			}<br /> 		end: {<br /> 			speed: {"+f.end.speed.x+", "+f.end.speed.y+"}<br /> 			flick: {"+f.end.flick.x+", "+f.end.flick.y+"}<br /> 			duration: "+f.end.duration+"<br /> 		} 		</pre>";g("#flickableDebugger").html(v)}})(Zepto);